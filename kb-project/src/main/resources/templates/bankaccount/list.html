<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Bank Account List</title>

<style>
/* 채팅 UI에 대한 CSS */
#chatContainer {
	border: 1px solid #ccc;
	padding: 10px;
	margin-top: 20px;
	overflow-y: auto;
	max-height: 400px;
}

.message {
	margin-bottom: 10px;
}

.userMessageContainer {
	display: flex;
	justify-content: flex-end;
}

.userMessage {
	background-color: #DCF8C6;
	color: #333;
	padding: 5px 10px;
	border-radius: 10px;
	margin-left: 10px;
}

.serverMessageContainer {
	display: flex;
	justify-content: flex-start;
}

.serverMessage {
	background-color: #F4F4F4;
	color: #333;
	padding: 5px 10px;
	border-radius: 10px;
	margin-right: 10px;
	text-align: left;
}
</style>

</head>

<body>
	<h1>계좌</h1>


	<tbody th:unless="${bankAccounts != null}">
		<tr>
			<td colspan="4">No bank accounts found.</td>
		</tr>

	</tbody>

	</table>

	<h1>음성 인식</h1>

	<div id="result"></div>

	<h1>채팅</h1>
	<div id="chatContainer"></div>

	<button id="startBtn">Start</button>
	<button id="stopBtn">Stop</button>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

	<script>
		const socket = new WebSocket('ws://localhost:8080/socket');
		let recognition;

		// 웹 소켓이 열렸을 때 실행되는 이벤트 핸들러
		socket.onopen = function(event) {
			console.log('WebSocket connection established.');
			message = "무엇을 도와드릴까요?"
			speakText(message)
			displayMessage(message, 'server');
		};

		// 웹 소켓으로부터 메시지를 받았을 때 실행되는 이벤트 핸들러
		socket.onmessage = function(event) {
			const message = event.data;
			console.log('Received message:', message);
			displayMessage(message, 'server'); // 서버 메시지를 채팅 UI에 표시
			speakText(message);
		};

		// 웹 소켓이 닫혔을 때 실행되는 이벤트 핸들러
		socket.onclose = function(event) {
			console.log('WebSocket connection closed.');
		};

		// 에러시 출력
		socket.onerror = function(event) {
			console.error('WebSocket error:', event);
		};

		// 서버로 메시지를 보내는 함수
		function sendMessage(message) {
			socket.send(message);
		}

		// 사용자 메시지와 서버 메시지를 번갈아가며 채팅 UI에 표시하는 함수
		function displayMessage(message, sender) {
			const messageContainerClass = sender === 'user' ? 'userMessageContainer'
					: 'serverMessageContainer';
			const messageClass = sender === 'user' ? 'userMessage'
					: 'serverMessage';

			const messageHTML = '<div class="message ' + messageContainerClass + '">'
					+ '<div class="' + messageClass + '">'
					+ message
					+ '</div>'
					+ '</div>';

			$('#chatContainer').append(messageHTML);
			scrollToBottom();
		}

		// 채팅 UI를 맨 아래로 스크롤하는 함수
		function scrollToBottom() {
			$('#chatContainer').scrollTop($('#chatContainer')[0].scrollHeight);
		}

		// 음성 인식 시작
		$(document).ready(function() {
			$('#startBtn').click(startRecognition);
			$('#stopBtn').click(stopRecognition);
		});

		function startRecognition() {
			recognition = new webkitSpeechRecognition();
			recognition.lang = 'ko-KR';
			recognition.continuous = true;

			recognition.onresult = function(event) {
				const transcript = event.results[0][0].transcript;
				console.log(transcript);
				displayMessage(transcript, 'user'); // 사용자 메시지를 채팅 UI에 표시
				processMessage(transcript);
			};

			recognition.onerror = function(event) {
				console.error('음성 인식 오류:', event.error);
			};

			recognition.start();
		}

		function stopRecognition() {
			if (recognition) {
				recognition.stop();
			}
		}

		function processMessage(message) {
			sendMessage(message); // 메시지를 서버로 전송
		}

		function speakText(text) {
			const msg = new SpeechSynthesisUtterance();
			msg.text = text;
			msg.lang = 'ko-KR';
			msg.rate = 0.9
			window.speechSynthesis.speak(msg);
		}
	</script>

</body>


<head th:replace="/fragments/header.html :: head">
<link href="/css/box.css" rel="stylesheet">
<meta charset="UTF-8">
<title>계좌조회</title>
</head>

<body>
	<!-- ======= Header ======= -->
	<header th:replace="/fragments/header.html :: header"></header>
	<!-- End Header -->
	<link href="/css/table.css" rel="stylesheet">

	<div th:if="${bankAccounts != null}" id="box" class="container"
		style="margin-top: 105px; background-color: #FFFFFF; width: 800px; height: 600px; border-radius: 15px; box-shadow: 0 0.9rem 1.7rem rgba(0, 0, 0, 0.25), 0 0.7rem 0.7rem rgba(0, 0, 0, 0.22);">
			<div class="p-2 text-center">
				<h2>계좌조회</h2>
			</div>
		<div class="container"
			style="overflow: auto; width: 500px; height: 480px;">
			<table th:each="bankAccount : ${bankAccounts}"
				style="border: 1px solid black; margin: 15px; margin-left: auto; margin-right: auto;">
				<thead>
					<tr>
						<th><span>은행</span></th>
						<th><span th:text="${bankAccount.bank.bankname}"></span></th>

						<th><span>계좌번호</span></th>
						<th><a
							th:href="@{/log/{accountNumber}(accountNumber=${bankAccount.accountNumber})}"
							style="color: red;"> <span
								th:text="${bankAccount.accountNumber}"></span>
						</a></th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td><span></span></td>
						<td><span>잔액</span></td>
						<td><span></span></td>
						<td><span th:text="${bankAccount.amount}"></span></td>
					</tr>
					<tr>
						<td><span></span></td>
						<td><span>주계좌설정</span></td>
						<td><span></span></td>
						<th><a
							th:href="@{/bankaccounts/mainAccount/{id}(id=${bankAccount.id})}"
							style="color: red;"> <span
								th:text="${bankAccount.accountNumber}"></span>
						</a></th>
					</tr>

				</tbody>
			</table>
		</div>
		<a href="/bankaccounts/create"><button class="custom-btn btn-3">
				<span>계좌생성</span>
			</button></a> <a th:href="@{/users/main}"><button class="custom-btn btn-3">
				<span> 메인으로 돌아가기 </span>
			</button></a>
	</div>
	<div th:unless="${bankAccounts != null}">
		<p>No bank accounts found.</p>
	</div>
	<div id="preloader"></div>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
		crossorigin="anonymous"></script>

	<!-- Vendor JS Files -->
	<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
	<script src="/assets/vendor/aos/aos.js"></script>
	<script src="/assets/vendor/glightbox/js/glightbox.min.js"></script>
	<script src="/assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
	<script src="/assets/vendor/swiper/swiper-bundle.min.js"></script>
	<script src="/assets/vendor/purecounter/purecounter_vanilla.js"></script>
	<script src="/assets/vendor/php-email-form/validate.js"></script>

	<!-- Template Main JS File -->
	<script src="/assets/js/main.js"></script>

</body>


</html>